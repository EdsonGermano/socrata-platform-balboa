package com.blist.metrics.impl.queue

import javax.jms._

import com.socrata.balboa.metrics.{Metric, Metrics}
import com.socrata.balboa.metrics.impl.JsonMessage
import com.socrata.metrics.{Fluff, MetricQueue}
import org.scalatest.mock.MockitoSugar
import org.scalatest.{Matchers, WordSpec}
import org.mockito.Mockito._

import scala.collection.immutable.IndexedSeq

class MetricJmsQueueSpec extends WordSpec with Matchers with MockitoSugar {

  trait QueueSetup {
    val mockQueue: Queue = mock[Queue]

    val mockProducer: MessageProducer = mock[MessageProducer]

    val mockSession: Session = mock[Session]

    when(mockSession.createQueue("not-a-real-queue")).thenReturn(mockQueue)
    when(mockSession.createProducer(mockQueue)).thenReturn(mockProducer)

    val mockConnection: Connection = mock[Connection]

    when(mockConnection.createSession(false, Session.AUTO_ACKNOWLEDGE)).thenReturn(mockSession)

    case class MetricRecord(timestamp: Long, entityId: String, name: String, value: Long, recordType: Metric.RecordType)

    val testMetrics: IndexedSeq[MetricRecord] = IndexedSeq(
      MetricRecord(1496268557542l, "3", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "3", "num-metadata-available", 114,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "1", "num-metadata-completed", 5339,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "1", "num-metadata-available", 20916,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "14", "num-metadata-completed", 41,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "14", "num-metadata-available", 270,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "5", "num-metadata-available", 90,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "7", "num-metadata-completed", 408,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "5", "num-metadata-completed", 23,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "7", "num-metadata-available", 1422,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "8", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "8", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "9", "num-metadata-completed", 12245,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "9", "num-metadata-available", 49542,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "10", "num-metadata-completed", 21667,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "10", "num-metadata-available", 65202,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "13", "num-metadata-completed", 29,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "13", "num-metadata-available", 90,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "16", "num-metadata-completed", 93,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "16", "num-metadata-available", 504,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "18", "num-metadata-completed", 2971,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "18", "num-metadata-available", 14748,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "19", "num-metadata-completed", 251,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "19", "num-metadata-available", 756,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "23", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "23", "num-metadata-available", 828,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "20", "num-metadata-completed", 288,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "20", "num-metadata-available", 861,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "31", "num-metadata-completed", 22,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "31", "num-metadata-available", 1014,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "35", "num-metadata-completed", 23,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "35", "num-metadata-available", 96,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "36", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "36", "num-metadata-available", 66,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "41", "num-metadata-completed", 108,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "41", "num-metadata-available", 534,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "43", "num-metadata-completed", 27,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "43", "num-metadata-available", 354,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "44", "num-metadata-completed", 20,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "44", "num-metadata-available", 180,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "45", "num-metadata-completed", 50,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "45", "num-metadata-available", 378,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "46", "num-metadata-completed", 37,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "46", "num-metadata-available", 192,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "48", "num-metadata-completed", 5,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "48", "num-metadata-available", 18,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "39", "num-metadata-completed", 3343,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "39", "num-metadata-available", 26106,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "51", "num-metadata-completed", 2,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "51", "num-metadata-available", 66,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "52", "num-metadata-completed", 22,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "52", "num-metadata-available", 123,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "53", "num-metadata-completed", 11,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "53", "num-metadata-available", 30,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "54", "num-metadata-completed", 2136,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "54", "num-metadata-available", 2755,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "62", "num-metadata-completed", 7,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "62", "num-metadata-available", 48,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "33", "num-metadata-completed", 46,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "33", "num-metadata-available", 369,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "34", "num-metadata-completed", 161,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "34", "num-metadata-available", 2004,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "64", "num-metadata-completed", 22,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "64", "num-metadata-available", 126,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "65", "num-metadata-completed", 27,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "65", "num-metadata-available", 168,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "67", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "67", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "66", "num-metadata-completed", 170214,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "66", "num-metadata-available", 255642,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "76", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "76", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "92", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "92", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "93", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "93", "num-metadata-available", 81,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "94", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "94", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "95", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "95", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "96", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "96", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "97", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "97", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "98", "num-metadata-completed", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "98", "num-metadata-available", 18,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "99", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "99", "num-metadata-available", 9,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "100", "num-metadata-completed", 1,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "100", "num-metadata-available", 9,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "101", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "101", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "102", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "102", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "103", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "103", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "104", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "104", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "105", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "105", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "106", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "106", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "107", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "107", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "108", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "108", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "109", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "109", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "110", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "110", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "111", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "111", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "112", "num-metadata-completed", 31,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "112", "num-metadata-available", 330,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "17", "num-metadata-completed", 254,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "17", "num-metadata-available", 756,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "113", "num-metadata-completed", 2,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "113", "num-metadata-available", 132,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "114", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "114", "num-metadata-available", 9,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "115", "num-metadata-completed", 15,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "115", "num-metadata-available", 177,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "116", "num-metadata-completed", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "116", "num-metadata-available", 8,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "117", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "117", "num-metadata-available", 6,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "118", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "118", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "119", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "119", "num-metadata-available", 63,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "120", "num-metadata-completed", 31,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "120", "num-metadata-available", 69,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "121", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "121", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "122", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "122", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "123", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "123", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "124", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "124", "num-metadata-available", 327,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "125", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "125", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "126", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "126", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "127", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "127", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "128", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "128", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "129", "num-metadata-completed", 15,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "129", "num-metadata-available", 39,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "130", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "130", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "131", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "131", "num-metadata-available", 12,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "132", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "132", "num-metadata-available", 417,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "133", "num-metadata-completed", 1280,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "133", "num-metadata-available", 1935,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "134", "num-metadata-completed", 4,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "134", "num-metadata-available", 36,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "69", "num-metadata-completed", 1,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "69", "num-metadata-available", 12,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "88", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "88", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "42", "num-metadata-completed", 23,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "42", "num-metadata-available", 90,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "56", "num-metadata-completed", 97,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "56", "num-metadata-available", 498,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "135", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "135", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "136", "num-metadata-completed", 76,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "136", "num-metadata-available", 387,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "137", "num-metadata-completed", 11,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "137", "num-metadata-available", 69,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "138", "num-metadata-completed", 25,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "138", "num-metadata-available", 96,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "139", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "139", "num-metadata-available", 6,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "140", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "140", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "141", "num-metadata-completed", 16,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "141", "num-metadata-available", 162,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "142", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "142", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "143", "num-metadata-completed", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "143", "num-metadata-available", 12,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "144", "num-metadata-completed", 1,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "144", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "145", "num-metadata-completed", 334,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "145", "num-metadata-available", 1266,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "146", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "146", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "147", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "147", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "148", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "148", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "149", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "149", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "150", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "150", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "151", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "151", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "152", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "152", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "153", "num-metadata-completed", 2,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "153", "num-metadata-available", 18,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "154", "num-metadata-completed", 32,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "154", "num-metadata-available", 147,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "155", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "155", "num-metadata-available", 6,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "156", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "156", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "157", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "157", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "158", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "158", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "159", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "159", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "160", "num-metadata-completed", 12,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "160", "num-metadata-available", 42,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "161", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "161", "num-metadata-available", 42,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "162", "num-metadata-completed", 23,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "162", "num-metadata-available", 84,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "163", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "163", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "164", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "164", "num-metadata-available", 9,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "82", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "82", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "25", "num-metadata-completed", 235,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "25", "num-metadata-available", 456,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "26", "num-metadata-completed", 182,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "26", "num-metadata-available", 237,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "27", "num-metadata-completed", 368,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "27", "num-metadata-available", 468,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "11", "num-metadata-completed", 1743,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "11", "num-metadata-available", 2322,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "89", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "89", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "57", "num-metadata-completed", 22,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "57", "num-metadata-available", 66,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "12", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "12", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "71", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "71", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "2", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "2", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "47", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "47", "num-metadata-available", 39,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "83", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "83", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "15", "num-metadata-completed", 284,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "15", "num-metadata-available", 804,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "77", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "77", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "73", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "73", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "40", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "40", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "91", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "91", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "21", "num-metadata-completed", 248,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "21", "num-metadata-available", 750,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "85", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "85", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "32", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "32", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "78", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "78", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "24", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "24", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "55", "num-metadata-completed", 8,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "55", "num-metadata-available", 27,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "68", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "68", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "38", "num-metadata-completed", 22,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "38", "num-metadata-available", 129,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "80", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "80", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "28", "num-metadata-completed", 101,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "28", "num-metadata-available", 294,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "30", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "30", "num-metadata-available", 63,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "50", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "50", "num-metadata-available", 66,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "81", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "81", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "79", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "79", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "90", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "90", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "59", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "59", "num-metadata-available", 63,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "84", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "84", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "74", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "74", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "6", "num-metadata-completed", 66,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "6", "num-metadata-available", 198,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "29", "num-metadata-completed", 74,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "29", "num-metadata-available", 138,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "4", "num-metadata-completed", 252,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "4", "num-metadata-available", 1260,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "58", "num-metadata-completed", 88,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "58", "num-metadata-available", 345,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "86", "num-metadata-completed", 2,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "86", "num-metadata-available", 3,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "70", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "70", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "60", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "60", "num-metadata-available", 63,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "75", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "75", "num-metadata-available", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "61", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "61", "num-metadata-available", 30,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "87", "num-metadata-completed", 0,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "87", "num-metadata-available", 9,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "63", "num-metadata-completed", 21,  Metric.RecordType.ABSOLUTE),
      (1496268557542l, "63", "num-metadata-available", 69,  Metric.RecordType.ABSOLUTE)
    )
  }

  val agg = Metric.RecordType.AGGREGATE
  val abs = Metric.RecordType.ABSOLUTE
  val granularity = MetricQueue.AGGREGATE_GRANULARITY

  "when queued with metrics" should {
    "send those metrics over ActiveMQ" in new QueueSetup {
      val queue = new MetricJmsQueue(mockConnection, "not-a-real-queue", 2)

      testMetrics.foreach( r => {
        queue.create(Fluff(r._2), Fluff(r._3), r._4, r._1, r._5)
      } )

      val bucketedMetrics = testMetrics.foldLeft(Map.empty[(Long,String),Metrics])((accum, metric) => {
        accum.get((metric._1, metric._2)) match {
          case Some(metrics: Metrics) => {
            val metricObj = new Metric()
            metricObj.setValue(metric._4)
            metricObj.setType(metric._5)
            accum ++ Map[(Long,String), Metrics]((metric._1,metric._2) -> {
              metrics.put(metric._3, metricObj)
              new Metrics(metrics)
            })
          }
          case None => Map.empty
        }
      })

      bucketedMetrics.foreach( (bucket) => {
        val (identifier, metrics) = bucket
        val (timestamp, entityId) = identifier
        val msg = new JsonMessage
        msg.setEntityId(entityId)
        msg.setMetrics(metrics)
        msg.setTimestamp(timestamp)
        val bytes = msg.serialize
        verify(mockSession).createTextMessage(new String(bytes))
      })
    }
  }
}
